---
title: Problematic nuggets
format: 
  html: default
  # revealjs:
  #   scrollable: true
  #   toc: true     # this adds a TOC slide at the beginning
execute:
  cache: true
  echo: true
---

## setup

```{r}
#| label: setup
#| include: false
#| echo: true
library(ggplot2)
library(tsibbledata)
library(dplyr)
library(lubridate)
library(tsibble)
library(ggtime)
```

## fig-inaccurate-dst-slopes

When plotting data with daylight saving time (DST) transitions, the slopes of the lines can become inaccurate. This is particularly evident when plotting sub-daily data that crosses a DST boundary, but also has a slight effect on daily and higher frequency data. The issue arises because the temporal duration / mass is not consistent despite the visual representation using equal spacing.


<!-- TODO: always show civil time as AM/PM and absolute time as 24h time -->
<!-- this needs to be re-written using geom_time_line() --->

```{r}
tz_shift <- as_tibble(tsibbledata::gafa_stock) |>
  filter(
    (Symbol == "AAPL" & Date <= "2014-01-15") | 
      (Symbol == "GOOG" & Date <= "2014-01-13")
  ) |>
  mutate(Date = Sys.Date() + hours(c(1:3, 3:9, 1:2, 4:9)), DST = ifelse(Symbol == "AAPL", "DST Ends", "DST Begins")) |> 
  slice(1:3, 3:12, 12:n()) |> 
  mutate(
    open = duplicated(Open),
    closed = c(open[-1], FALSE),
    Date = Date + open*3600*((DST=="DST Begins")*2-1)
  )
```
Comparing the two lines:

```{r}
#| label: civil-dst-compare
tz_shift |> 
  ggplot(aes(x = Date, y = Close)) + 
  geom_path(aes(group = cumsum(open)), color = "yellow", alpha = 0.5) + 
  geom_path(linetype = "dashed", data = filter(tz_shift, open | closed), color = "yellow", alpha = 0.5) +
  geom_path(data = filter(tz_shift, !open), colour = "red", alpha = 0.5) +
  facet_wrap(vars(DST), ncol = 2, scales = "free_y") + 
  scale_shape_manual(values = c("TRUE" = 16, "FALSE" = 1)) + 
  labs(x = "")
  guides(shape = "none")
```


Note: slopes and other mathematics on time should always be done using absolute time, not civil time. This is because civil time does not accurately represent the temporal mass of the data, and so any calculations on civil time can produce misleading results.